name: Inspect OpenMS Release Package

on:
  workflow_dispatch:

env:
  TOPP_TOOLS: "OpenNuXL FileConverter PercolatorAdapter"
      
jobs:
  use-release:
    runs-on: ubuntu-latest

    permissions:
      contents: read   # required to read release assets
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenMS release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download OpenMS_3_5_windows \
            --repo Arslan-Siraj/nuxl_webapp_supporting_files \
            --pattern "*.zip"

      - name: Verify downloaded file
        run: |
          ls -lh
          file *.zip
          unzip -t *.zip

      - name: Extract OpenMS package
        run: |
          unzip *.zip -d openms-package
          ls -R openms-package

      - name: Extract inner OpenMS package
        run: |
          unzip \
            openms-package/openms-package/OpenMS/bld/openms-package.zip \
            -d openms-inner

      - name: Promote OpenMS bin and share to root
        run: |
          mkdir -p openms-bin openms-share

          cp -r openms-inner/openms-package/bin/* openms-bin/
          cp -r openms-inner/openms-package/share/* openms-share/

      - name: Prepare Streamlit executable layout
        run: |
          # Create target folder
          mkdir -p streamlit_exe streamlit_exe/share
      
          # Copy all DLLs from openms-bin
          cp -r openms-bin/*.dll streamlit_exe/
      
          # Copy share folder
          cp -r openms-share/* streamlit_exe/share/

          # Copy only selected .exe files from openms-bin
          for tool in $TOPP_TOOLS; do
            if [ -f "openms-bin/$tool.exe" ]; then
              cp "openms-bin/$tool.exe" streamlit_exe/
            else
              echo "Warning: $tool.exe not found in openms-bin"
            fi
          done

      - name: Upload streamlit_exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: streamlit_exe
          path: streamlit_exe
        
